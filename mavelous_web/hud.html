<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="format-detection" content="telephone=no">
<title>Hud</title>
<script src="http://smoothiecharts.org/smoothie.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="/mav/Cesium/Cesium.js"></script>
<script src="hud.js" > </script>
<style>
    @import url(/mav/Cesium/Widgets/widgets.css);
</style>

<script type="application/x-javascript">
                <!--

                    var jsoncount=0;
                    var markers = [];
                    var wpmarkers = [];
                    var flightPath;
                    var pathHistoryPoly;
                    var pathHistory = [];
                    var socket;
                    var socket2;

                    var line1item = "cs.altasl";
                    var line2item = "cs.ter_alt";

                    function graphitem(item)
                    {
                        line1item = "cs."+item;
                    }

                    function init() {

                            var smoothie = new SmoothieChart();

                    smoothie.streamTo(document.getElementById("graphcanvas"));

                    // Data
                    var line1 = new TimeSeries();
                    var line2 = new TimeSeries();

        // Add to SmoothieChart
        smoothie.addTimeSeries(line1);
        smoothie.addTimeSeries(line2);


                    if (window["WebSocket"]) {
                        var host = "ws://"+window.location.hostname+":56781/websocket/server";
                        if(window.location.hostname == "")
                            host = "ws://localhost:56781/websocket/server";
                    try{
                    socket = new WebSocket(host);

                    window.onbeforeunload = function(){ socket.close(); socket2.close(); }
                    //log('WebSocket - status '+socket.readyState);
                    socket.onopen    = function(msg){ document.getElementById("serverStatus").innerHTML = "onopen"; jsoncount=0; };
                    socket.onmessage = function(msg){
                        jsoncount++;

                        var data = JSON.parse(msg.data);

                        if(data.hasOwnProperty('FrameString'))
                        {
                            MAV = data;
                        }
                        else if(data.hasOwnProperty('rateattitude'))
                        {
                            cs = data;


                            var status = "<ul style='columns: 3;'>";

                            a=1;

                var sortable = [];
                    for (i in cs)
                            {
                            sortable.push(i);
                            }

                            sortable.sort(function (a, b) {
                    return a.toLowerCase().localeCompare(b.toLowerCase());
                });

                            for (i in sortable)
                            {
                                var name = sortable[i];
                                var data = cs[sortable[i]];

                                if(typeof data != 'object')
                                    status += "<li style='overflow:hidden; white-space: nowrap;'><b onclick=graphitem('" + name + "')>" + name + ":</b><br> " + data + "</li>";

                                //if(a%3==0)
                                    //status += "<br>";

                                a++;
                            }

                            status+="</ul>";

                            document.getElementById("serverStatus").innerHTML = status;

                            map.setCenter({lat: cs.lat, lng: cs.lng});

                            if(jsoncount < 5)
                            {
                                map.setZoom(18);
                            }

                            roll = cs.roll;
                            pitch = cs.pitch;
                            yaw = cs.yaw;

                            lat = cs.lat;
                            lng = cs.lng;
                            alt = cs.alt;

                            try {

                        var myLatLng = {lat: lat, lng: lng};

                    if(markers.length > 0)
                    {
                        markers[0].setPosition(myLatLng);
                    } else {
                        var marker = new google.maps.Marker({
                            position: myLatLng,
                            map: map,
                            title: 'ArduPilot'
                       });

                        markers.push(marker);
                    }

                    map.setOptions({maxZoom: 21});

                          //socket.send("test "+pitch+"\n");
                          } catch (ex){ }// alert(ex); }

                          line1.append(new Date().getTime(), eval(line1item));
                          line2.append(new Date().getTime(), eval(line2item));


                            pathHistory.push({lat: lat, lng: lng});

                            pathHistory = pathHistory.slice(-200,200);


                            if(pathHistoryPoly == null) {
                            pathHistoryPoly = new google.maps.Polyline({
                              path: pathHistory,
                              geodesic: true,
                              strokeColor: '#191970',
                              strokeOpacity: 0.56,
                              strokeWeight: 4
                            });

                            pathHistoryPoly.setMap(map);
                            } else {
                                pathHistoryPoly.setPath(pathHistory);
                            }
                        }
                        else if(data[0].hasOwnProperty('mission_type'))
                        {
                            wps = data;

                            var wpscoords = [];
                            for (i in wps)
                            {
                            if (wps[i].x != 0 && wps[i].y != 0)
                            {
                            wpscoords.push({lat: wps[i].x, lng: wps[i].y, alt: wps[i].z, frame: wps[i].frame, label: wps[i].seq });
                            }
                            }

                            if(wpmarkers.length == wpscoords.length)
                            {
                            i=0;
                            wpmarkers.forEach(function(element)
                            {
                            element.setPosition(wpscoords[i]);
                            i++;
                            });
                            } else {
                            wpmarkers.forEach(function(element)
                            {element.setMap(null)});
                            wpmarkers = [];
                            // Create markers.
                            wpscoords.forEach(function(feature) {
                            var marker = new google.maps.Marker({
                            position: feature,
                            icon: 'https://maps.gstatic.com/mapfiles/ms2/micons/green.png',
                            map: map,
                            label: (feature.label == 0) ? "Home" : feature.label+"",
                            draggable:true,
                            title: (feature.label == 0) ? "Home" : feature.label+""
                            });
                            wpmarkers.push(marker);

                            google.maps.event.addListener(marker, 'dragend', function (event) {
                            document.getElementById("latbox").value = event.latLng.lat();
                            document.getElementById("lngbox").value = event.latLng.lng();
                            });
                            });
                            }

    var pnts = [];
    wpscoords.forEach(function(feature)
    {
        pnts.push(feature.lng);
        pnts.push(feature.lat);
        pnts.push(feature.alt + cs.HomeAlt);
    });

     if (viewer != null) {
        var orangeOutlined = viewer.entities.add({
        name : 'Orange line with black outline at height and following the surface',
        polyline : {
            positions : Cesium.Cartesian3.fromDegreesArrayHeights(pnts),
            width : 4,
            material : new Cesium.PolylineOutlineMaterialProperty({
                color : Cesium.Color.ORANGE,
                outlineWidth : 2,
                outlineColor : Cesium.Color.BLACK
            })
        }
    });

    //orangeOutlined.position = Cesium.Cartesian3.fromDegrees(lng, lat);

    //viewer.trackedEntity = orangeOutlined;
    }

                            if(flightPath == null) {
                            flightPath = new google.maps.Polyline({
                            path: wpscoords,
                            geodesic: true,
                            strokeColor: '#FFFF00',
                            strokeOpacity: 1.0,
                            strokeWeight: 4
                            });

                            flightPath.setMap(map);
                            } else {
                            flightPath.setPath(wpscoords);
                            }

                        } else { return; }


                    };
                    socket.onerror   = function(msg){ document.getElementById("serverStatus").innerHTML = "Error: "+msg.data; };
                    socket.onclose   = function(msg){ document.getElementById("serverStatus").innerHTML = "Disconnected - status "+this.readyState; setTimeout ( "init()", 1000 );  };
                    }
                    catch(ex){ if (window.console) console.log(exception);  document.getElementById("serverStatus").innerHTML = ex; }
                    } else {
                    document.getElementById("serverStatus").innerHTML = "This browser doesnt support websockets";
                    }

                    draw();

                    }


                    -->
    </script>
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #map {
        height: 100%;
    }
</style>

</head>
<body onload="init();">
<div id="message" style="position:absolute;">message</div>
<div style="height: 100%; display: flex; flex-direction: column; float: left; resize: horizontal; overflow: auto;">
    <div style="float: left;">
        <canvas id="canvas" width="500" height="375">
            <p>
                This example requires a browser that supports the
                <a href="http://www.w3.org/html/wg/html5/">HTML5</a>
                &lt;canvas&gt; feature.
            </p>
        </canvas><br>
        Lat: <input id="latbox" name="lat" val="40.713956"/>Long: <input id="lngbox" name="long" val="74.006653"/> <br/>
        <canvas id="graphcanvas" width="500" height="80"></canvas><br/>
        <div id="curve_chart" style="width: 500px; height: 400px; display: none;"></div>
    </div>
    <div id="serverStatus" style="width: 500px; overflow-y: auto; flex-grow: 0;"></div>
</div>
<div style="height: 100%; display: flex; flex-direction: column; resize: horizontal; overflow: auto;">

    <!--<canvas id="canvas" width="300" height="200" style=""></canvas><br>

    <div id="log"></div>
    -->
    <div id="cesiumContainer" style="height: 50%; display: none;"></div>
    <div id="map"></div>
</div>
<script>
    var map;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'),
            {
                center: { lat: -35, lng: 117.89 },
                zoom: 8,
                mapTypeId: 'satellite',
                maxZoom: 21
            });

        map.setMapTypeId('satellite');
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDW05vWXeNIfZAN4Ter8gf4YLg8rPHZToc&callback=initMap" async defer></script>
<script>
    var viewer = new Cesium.Viewer('cesiumContainer');
</script>
    
<script>
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        var data = google.visualization.arrayToDataTable([
            ['Year', 'Sales', 'Expenses'],
            ['2004', 1000, 400],
            ['2005', 1170, 460],
            ['2006', 660, 1120],
            ['2007', 1030, 540]
        ]);

        var options = {
            title: 'Company Performance',
            curveType: 'function',
            legend: { position: 'bottom' }
        };

        var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

        chart.draw(data, options);
    }
</script>
    
    

<script type="text/javascript">

    var jsilConfig = {
        printStackTrace: true,

        xna: 4,

        showProgressBar: true,

        winForms: true,

        libraryRoot: "/mav/Libraries/",

        scriptRoot: "/mav/mavlink/",

        fileRoot: "/mav/file/",

        bclMode11: "translated",

        manifests: [
            "/mav/mavlink/MAVLink.dll"
        ],

    };

</script>
<script src="/mav/Libraries/JSIL.js" type="text/javascript"></script>

<script>

    onLoad();

    JSIL.Initialize();

    var asm = JSIL.GetAssembly("MAVLink");

    function runMain() {

//################################################
        try {
            var host = "ws://" + window.location.hostname + ":56781/websocket/raw";
            if (window.location.hostname == "")
                host = "ws://localhost:56781/websocket/raw";
            socket2 = new WebSocket(host);
            //log('WebSocket - status '+socket.readyState);
            socket2.onopen = function(msg) { document.getElementById("serverStatus").innerHTML = "onopen"; };
            socket2.onmessage = function(msg) {
                var reader = new FileReader();
                reader.addEventListener("loadend", function() {
	
                    var packet = new asm.MAVLink_MAVLinkMessage(new Uint8Array(this.result));

                    document.getElementById("message").innerHTML = packet.msgtypename+'';
                            
                });
                reader.readAsArrayBuffer(msg.data);				
            };
            socket2.onerror = function(msg) {
                document.getElementById("serverStatus").innerHTML = "Error: " + msg.data;
            };
            socket2.onclose = function(msg) {
                document.getElementById("serverStatus").innerHTML = "Disconnected - status " + this.readyState;
                setTimeout("runMain()", 1000);
            };
        } catch (ex) {
            if (window.console) console.log(exception);
            document.getElementById("serverStatus").innerHTML = ex;
        }

        //############################################################
        var test = new asm.MAVLink();

        var test2 = new asm.MAVLink_MAVLinkMessage();

        var parse = new asm.MAVLink_MavlinkParse();
    }
</script>


</body>
</html>